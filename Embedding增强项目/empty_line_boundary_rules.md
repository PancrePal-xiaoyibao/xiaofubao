# 空行边界处理规则设计文档

## 核心原则

**空行永远不应该成为分块边界（chunk boundary）**

## 设计理念

### 1. 语义完整性
- 空行通常用于分隔段落或章节，但本身不包含语义信息
- 在空行处插入边界标记会破坏文档的自然结构
- 空行应该被视为内容的一部分，而不是分割点

### 2. 可读性保持
- 空行有助于提高文档的可读性
- 在空行处分块会导致不自然的分割
- 保持空行与其前后内容的关联性

### 3. 边界优先级系统
- 优先级 0：非边界行（包括空行）
- 优先级 1：中文一级序号（一、二、三、等）
- 优先级 2：Markdown一级标题（#）
- 优先级 3：Markdown二级标题（##）
- 优先级 4：其他标题级别

## 实现规则

### 1. 边界检测规则
```python
def get_chunk_boundary_priority(line):
    stripped_line = line.strip()
    
    # 关键规则：空行永远不应该成为分块边界
    if not stripped_line:
        return 0
    
    # 其他边界检测逻辑...
```

### 2. 分块决策规则
```python
def should_start_new_chunk(line, current_chunk_lines, max_chars_per_chunk, all_lines=None, current_index=None):
    # 获取当前行的边界优先级
    current_priority = get_chunk_boundary_priority(line)
    
    # 如果不是边界行（包括空行），不分块
    if current_priority == 0:
        return False
    
    # 其他分块逻辑...
```

### 3. 边界标记生成规则
- 边界标记只在有意义的内容分割点插入
- 避免在空行前后插入重复的边界标记
- 保持文档结构的自然性

## 测试用例

### 测试场景1：连续空行
```
内容行1

内容行2
```
**期望结果**：不在空行处分块

### 测试场景2：空行与标题
```
内容行1

# 标题
内容行2
```
**期望结果**：在标题处分块，而不是空行处

### 测试场景3：段落间空行
```
段落1的内容

段落2的内容
```
**期望结果**：保持段落完整性，不在空行处分块

## 质量保证

### 1. 单元测试
- 测试空行的边界优先级为0
- 测试空行不触发分块
- 测试空行与其他边界类型的交互

### 2. 集成测试
- 测试包含大量空行的文档处理
- 测试空行与标题混合的场景
- 测试边界标记的正确插入位置

### 3. 回归测试
- 确保修复不影响现有功能
- 验证重复边界标记问题得到解决
- 检查文档结构完整性

## 预期效果

1. **减少无意义的分块**：避免在空行处产生无内容的chunk
2. **提高语义连贯性**：保持相关内容在同一chunk中
3. **改善检索质量**：更好的chunk边界有助于RAG系统检索
4. **增强可读性**：生成的分块文档更符合人类阅读习惯

## 实施计划

1. ✅ 修复 `get_chunk_boundary_priority` 函数
2. 🔄 创建专门的测试用例
3. ⏳ 更新现有测试套件
4. ⏳ 验证修复效果
5. ⏳ 文档更新和部署

## 相关文件

- `preprocess_enhanced.py`: 主要实现文件
- `test_empty_line_boundaries.py`: 专门测试文件
- `comprehensive_test_suite.py`: 综合测试套件
- `clean_duplicate_boundaries.py`: 边界清理工具